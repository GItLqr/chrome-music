<!DOCTYPE html> 
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>音乐电台</title>
</head>
<body>
<script>
//存储名
var storageName = 'chrome_music_name',
	sName = 'chrome_music_count',
	aName = 'chrome_music_check',
	musicList = {
	"ting":{
		url:"http://ting.baidu.com/radio/index.html?__methodName=setChannel&__argsValue=public_1",
		width:470,
		height:250,
	},
	"douban":{
		url:"http://douban.fm/radio",
		width:420,
		height:186,
	},
	"kugou":{
		url: "http://topic.kugou.com/radio/",
		width: 540,
		height: 250
	},
	"xiami":{
		url:"http://kuang.xiami.com/kuang/play/xiamiradio",
		width:535,
		height:280
	},
	"kuwo":{
		url:"http://player.kuwo.cn/webmusic/webdiantai/kuwoBaiduPlay.jsp",
		width:480,
		height:200
	},
	"leku":{
		url:"http://music.sina.com.cn/app/baidu/index.php",
		width:400,
		height:200
	},
	"duomi":{
		url:"http://app.duomiyy.com/songplayer/baidu",
		width:445,
		height:200
	},
	"yinyue":{
		url:"http://www.yinyuetai.com/baidu/index",
		width:800,
		height:445
	},
	"yige":{
		url:"http://www.1g1g.com/", 
		width:560,
		height:480
	},
	"renren":{
		url:"http://music.renren.com/fm", 
		width:455,
		height:215
	},
	"zhangmen":{
		url:"http://box.zhangmen.baidu.com/m?rf=idx&ct=134217728&tn=baidumt&gate=5", 
		width:510,
		height:575
	},
	"yishouge":{
		url:"http://www.yishouge.com/radio", 
		width:780,
		height:350
	},
	"sougou":{
		url:"http://player.mbox.sogou.com/player", 
		width:625,
		height:560
	},
	"google":{
		url:"http://www.google.cn/music/player", 
		width:765,
		height:470
	}
}
function getRandomMusicName(){
	var list = Object.getOwnPropertyNames(musicList), len = list.length;
	var r = Math.min(Math.floor(Math.random()*len), len-1);
	return list[r];
}
function getMusic(){
	var name = localStorage.getItem(storageName);
	if(!(name in musicList)){
		name = "random";
	}
	if(name == 'random'){
		name = getRandomMusicName();
	}
	return musicList[name];
}
//content_scripts需要musicList
chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
	if(request.music == 'get'){
		sendResponse(musicList)
	}else if(request.setItem == 1){
		localStorage.setItem(sName, 0);
		localStorage.setItem(aName, 0);
	}else if(request.from == 'options'){
		openCurrentWins();
		sendResponse({
			options: 'close'
		})
	}
});
function closeOtherWins(callback){
	chrome.windows.getAll({}, function(wins){
		wins.forEach(function(win){
			var winid = win.id;
			chrome.tabs.getAllInWindow(winid, function(tabs){
				tabs.forEach(function(tab){
					chrome.tabs.sendRequest(tab.id, {close:1}, function(response){

					})
				})
			})
		})
		callback && callback();
	})
}
function openCurrentWins(){
	var count = localStorage.getItem(sName) | 0, check = localStorage.getItem(aName) | 0;
	if(count == 1){
		if(check == 0){
			localStorage.setItem(aName, 1);
			return true;
		}else{
			localStorage.setItem(aName, 0);
			localStorage.setItem(sName, 0);
		}
	}
	closeOtherWins(function(){
		var music = getMusic();
		var pros = 'scrollbars=no,width='+music.width+',height='+music.height+',top=100,left=100,toolbar=no, menubar=no,scrollbars=no, resizable=no,location=no, status=no';
		localStorage.setItem(sName, 1);
		window.open(music.url+'#welefen', 'popup', pros);
	})
}
chrome.browserAction.onClicked.addListener(function(){
	openCurrentWins();
});
</script>
</body>
</html>